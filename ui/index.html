<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musequill - Book Creation Wizard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="./css/wizard.css">

    <!-- Alpine.js Components -->
    <script src="./js/stores/wizard-store.js"></script>
    <script src="./js/utils/api-client.js"></script>
    <script src="./js/components/progress-bar.js"></script>
    <script src="./js/components/step-container.js"></script>
    <script src="./js/components/navigation.js"></script>
    <script src="./js/steps/step-1-concept.js"></script>
    <script src="./js/steps/step-2-genre.js"></script>
    <script src="./js/steps/step-3-audience.js"></script>
    <script src="./js/steps/step-4-style.js"></script>
    <script src="./js/steps/step-5-length.js"></script>
    <script src="./js/steps/step-6-structure.js"></script>
    <script src="./js/steps/step-7-world.js"></script>
    <script src="./js/steps/step-8-content.js"></script>
    <script src="./js/steps/step-9-summary.js"></script>

    <!-- Enhanced Step 6 and 7 Components -->
    <script>
        // Enhanced step-6-structure.js implementation
        function step6Structure() {
            return {
                selectedStructure: '', isSubmitting: false, options: [], llmMessage: '', hoveredOption: null,
                get hasSelection() { return this.selectedStructure !== ''; },
                get canProceed() { return this.hasSelection; },
                get currentStepData() { return this.$store.wizard.currentStepData; },
                get selectedGenre() { return this.$store.wizard.formData.genre; },
                async selectStructure(structureId) {
                    this.selectedStructure = structureId;
                    this.$store.wizard.updateFormData('structure', structureId);
                    await this.processStructureSelection();
                },
                async processStructureSelection() {
                    if (!this.selectedStructure) return;
                    this.isSubmitting = true;
                    try {
                        const success = await this.$store.wizard.processStep(6, this.selectedStructure);
                        if (success) await this.proceedToNextStep();
                    } catch (error) {
                        console.error('Error processing structure selection:', error);
                    } finally { this.isSubmitting = false; }
                },
                async proceedToNextStep() {
                    this.$store.wizard.setCurrentStep(7);
                    await this.loadWorldBuildingData();
                },
                async loadWorldBuildingData() {
                    try { await this.$store.wizard.processStep(7, null); }
                    catch (error) { console.error('Error loading world building data:', error); }
                },
                loadStepData() {
                    const stepData = this.$store.wizard.currentStepData;
                    if (stepData && stepData.options && stepData.options.length > 0) {
                        this.options = stepData.options;
                    } else if (this.options.length === 0) {
                        this.options = this.getSampleStructures();
                    }
                    this.llmMessage = stepData?.llmReasoning || this.getDefaultMessage();
                    this.selectedStructure = this.$store.wizard.formData.structure || '';
                },
                getDefaultMessage() {
                    return `These proven structures work excellently for ${this.selectedGenre || 'your chosen genre'} books:`;
                },
                init() {
                    if (this.$store.wizard.currentStep !== 6) return;
                    this.options = this.getSampleStructures();
                    this.llmMessage = this.getDefaultMessage();
                    if (!this.$store.wizard.sessionId) return;
                    this.loadStepData();
                },
                async onStepVisible() {
                    if (this.$store.wizard.currentStep !== 6) return;
                    await this.$nextTick();
                    const freshStepData = this.$store.wizard.currentStepData;
                    if (freshStepData && freshStepData.options && freshStepData.options.length > 0) {
                        this.options = freshStepData.options;
                        this.llmMessage = freshStepData.llmReasoning || this.getDefaultMessage();
                        return;
                    }
                    if (this.options.length === 0) {
                        this.options = this.getSampleStructures();
                        this.llmMessage = this.getDefaultMessage();
                    }
                },
                getSampleStructures() {
                    const baseStructures = [
                        { id: 'three_act', name: 'Three-Act Structure', description: 'Classic beginning, middle, end with clear turning points', recommendation_score: 85, difficulty: 'easy', commercial_appeal: 'Very High', why_recommended: 'Time-tested structure with proven commercial success' },
                        { id: 'heros_journey', name: "Hero's Journey", description: 'Character transformation through challenges and growth', recommendation_score: 80, difficulty: 'medium', commercial_appeal: 'High', why_recommended: 'Deeply satisfying character arc that resonates with readers' },
                        { id: 'save_the_cat', name: 'Save the Cat! Structure', description: '15-beat structure optimized for commercial storytelling', recommendation_score: 90, difficulty: 'easy', commercial_appeal: 'Very High', why_recommended: 'Designed specifically for commercial success' }
                    ];
                    if (this.selectedGenre === 'romance') {
                        baseStructures.push({ id: 'romance_arc', name: 'Romance Beat Sheet', description: 'Specialized structure for romantic relationship development', recommendation_score: 95, difficulty: 'easy', commercial_appeal: 'Excellent', why_recommended: 'Proven formula for romance genre success' });
                    }
                    return baseStructures;
                },
                getStructureCardClass(structure) {
                    let baseClass = 'p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 ';
                    if (this.selectedStructure === structure.id) baseClass += 'border-blue-500 bg-blue-50 shadow-md ';
                    else if (this.hoveredOption === structure.id) baseClass += 'border-gray-300 bg-gray-50 shadow-sm ';
                    else baseClass += 'border-gray-200 hover:border-gray-300 hover:bg-gray-50 ';
                    return baseClass;
                },
                getRecommendationBadgeClass(score) {
                    if (score >= 90) return 'bg-green-100 text-green-800';
                    if (score >= 80) return 'bg-blue-100 text-blue-800';
                    if (score >= 70) return 'bg-yellow-100 text-yellow-800';
                    return 'bg-gray-100 text-gray-800';
                },
                getDifficultyBadgeClass(difficulty) {
                    const classes = { 'easy': 'bg-green-100 text-green-800', 'medium': 'bg-yellow-100 text-yellow-800', 'hard': 'bg-red-100 text-red-800' };
                    return classes[difficulty] || 'bg-gray-100 text-gray-800';
                },
                formatRecommendationScore(score) { return score ? `${Math.round(score)}% Match` : null; },
                formatDifficulty(difficulty) {
                    const difficultyMap = { 'easy': 'Easy to Execute', 'medium': 'Moderate Complexity', 'hard': 'Advanced Structure' };
                    return difficultyMap[difficulty] || difficulty;
                }
            };
        }

        // Enhanced step-7-world.js implementation
        function step7World() {
            return {
                selectedWorld: '', isSubmitting: false, options: [], llmMessage: '', hoveredOption: null,
                get hasSelection() { return this.selectedWorld !== ''; },
                get canProceed() { return this.hasSelection; },
                get currentStepData() { return this.$store.wizard.currentStepData; },
                get selectedGenre() { return this.$store.wizard.formData.genre; },
                async selectWorld(worldId) {
                    this.selectedWorld = worldId;
                    this.$store.wizard.updateFormData('world', worldId);
                    await this.processWorldSelection();
                },
                async processWorldSelection() {
                    if (!this.selectedWorld) return;
                    this.isSubmitting = true;
                    try {
                        const success = await this.$store.wizard.processStep(7, this.selectedWorld);
                        if (success) await this.proceedToNextStep();
                    } catch (error) {
                        console.error('Error processing world selection:', error);
                    } finally { this.isSubmitting = false; }
                },
                async proceedToNextStep() {
                    this.$store.wizard.setCurrentStep(8);
                    await this.loadContentPreferencesData();
                },
                async loadContentPreferencesData() {
                    try { await this.$store.wizard.processStep(8, null); }
                    catch (error) { console.error('Error loading content preferences data:', error); }
                },
                loadStepData() {
                    const stepData = this.$store.wizard.currentStepData;
                    if (stepData && stepData.options && stepData.options.length > 0) {
                        this.options = stepData.options;
                    } else if (this.options.length === 0) {
                        this.options = this.getSampleWorlds();
                    }
                    this.llmMessage = stepData?.llmReasoning || this.getDefaultMessage();
                    this.selectedWorld = this.$store.wizard.formData.world || '';
                },
                getDefaultMessage() {
                    return `For your ${this.selectedGenre || 'chosen genre'} story, these settings offer commercial appeal:`;
                },
                init() {
                    if (this.$store.wizard.currentStep !== 7) return;
                    this.options = this.getSampleWorlds();
                    this.llmMessage = this.getDefaultMessage();
                    if (!this.$store.wizard.sessionId) return;
                    this.loadStepData();
                },
                async onStepVisible() {
                    if (this.$store.wizard.currentStep !== 7) return;
                    await this.$nextTick();
                    const freshStepData = this.$store.wizard.currentStepData;
                    if (freshStepData && freshStepData.options && freshStepData.options.length > 0) {
                        this.options = freshStepData.options;
                        this.llmMessage = freshStepData.llmReasoning || this.getDefaultMessage();
                        return;
                    }
                    if (this.options.length === 0) {
                        this.options = this.getSampleWorlds();
                        this.llmMessage = this.getDefaultMessage();
                    }
                },
                getSampleWorlds() {
                    const baseWorlds = [
                        { id: 'contemporary', name: 'Contemporary/Modern Day', description: 'Present-day real-world settings that readers recognize', recommendation_score: 85, research_complexity: 'low', commercial_appeal: 'Very High', why_recommended: 'Familiar to readers, easy to write authentically' },
                        { id: 'small_town', name: 'Small Town/Community', description: 'Tight-knit communities with strong local connections', recommendation_score: 80, research_complexity: 'low', commercial_appeal: 'High', why_recommended: 'Relatable setting with built-in character dynamics' },
                        { id: 'historical', name: 'Historical Setting', description: 'Well-documented historical periods with established atmosphere', recommendation_score: 75, research_complexity: 'medium', commercial_appeal: 'High', why_recommended: 'Rich atmosphere and proven reader interest' }
                    ];
                    if (this.selectedGenre === 'fantasy') {
                        baseWorlds.push({ id: 'secondary_fantasy', name: 'Secondary Fantasy World', description: 'Original fantasy realm with magic systems and unique cultures', recommendation_score: 90, research_complexity: 'medium', commercial_appeal: 'Excellent', why_recommended: 'High demand in fantasy market with creative freedom' });
                        baseWorlds.push({ id: 'urban_fantasy', name: 'Urban Fantasy', description: 'Modern world with hidden magical elements', recommendation_score: 88, research_complexity: 'low', commercial_appeal: 'Very High', why_recommended: 'Combines familiar settings with exciting magical elements' });
                    }
                    return baseWorlds;
                },
                getWorldCardClass(world) {
                    let baseClass = 'p-4 border-2 rounded-lg cursor-pointer transition-all duration-200 ';
                    if (this.selectedWorld === world.id) baseClass += 'border-blue-500 bg-blue-50 shadow-md ';
                    else if (this.hoveredOption === world.id) baseClass += 'border-gray-300 bg-gray-50 shadow-sm ';
                    else baseClass += 'border-gray-200 hover:border-gray-300 hover:bg-gray-50 ';
                    return baseClass;
                },
                getRecommendationBadgeClass(score) {
                    if (score >= 90) return 'bg-green-100 text-green-800';
                    if (score >= 80) return 'bg-blue-100 text-blue-800';
                    if (score >= 70) return 'bg-yellow-100 text-yellow-800';
                    return 'bg-gray-100 text-gray-800';
                },
                getComplexityBadgeClass(complexity) {
                    const classes = { 'low': 'bg-green-100 text-green-800', 'medium': 'bg-yellow-100 text-yellow-800', 'high': 'bg-red-100 text-red-800' };
                    return classes[complexity] || 'bg-gray-100 text-gray-800';
                },
                formatRecommendationScore(score) { return score ? `${Math.round(score)}% Match` : null; },
                formatResearchComplexity(complexity) {
                    const complexityMap = { 'low': 'Minimal Research', 'medium': 'Moderate Research', 'high': 'Extensive Research' };
                    return complexityMap[complexity] || complexity;
                }
            };
        }
    </script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Debug Panel (Remove in production) -->
    <div x-data="{ showDebug: false }" class="fixed top-4 right-4 z-50">
        <button @click="showDebug = !showDebug" class="bg-gray-800 text-white px-3 py-1 rounded text-sm">
            Debug
        </button>
        <div x-show="showDebug"
            class="absolute top-8 right-0 bg-white border rounded-lg shadow-lg p-4 w-80 max-h-96 overflow-auto">
            <h3 class="font-bold mb-2">Wizard Store State</h3>
            <div class="text-xs space-y-1">
                <div><strong>Step:</strong> <span x-text="$store.wizard.currentStep"></span></div>
                <div><strong>SessionId:</strong> <span x-text="$store.wizard.sessionId"></span></div>
                <div><strong>Has Analysis:</strong> <span x-text="$store.wizard.conceptAnalysis ? 'Yes' : 'No'"></span>
                </div>
                <div><strong>Analysis Success:</strong>
                    <span x-text="$store.wizard.conceptAnalysis?.analysis_successful ? 'Yes' : 'No'"></span>
                </div>
                <div><strong>Form Data:</strong></div>
                <template x-for="(value, key) in $store.wizard.formData" :key="key">
                    <div><strong x-text="key"></strong>: <span x-text="value || 'empty'"></span></div>
                </template>
            </div>
        </div>
    </div>

    <div x-data="wizardStore" x-init="initWizard()">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-4xl mx-auto px-6 py-4">
                <h1 class="text-2xl font-bold text-gray-800">ðŸ“š Musequill Book Creation Wizard</h1>
                <p class="text-gray-600 mt-1">Create your perfect book blueprint in 9 simple steps</p>
            </div>
        </header>

        <!-- Progress Bar -->
        <div x-data="progressBar" class="bg-white border-b border-gray-200">
            <div class="max-w-4xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">
                        Step <span x-text="$store.wizard.currentStep"></span> of
                        <span x-text="$store.wizard.totalSteps"></span>
                    </span>
                    <span class="text-sm text-gray-500"
                        x-text="Math.round(($store.wizard.currentStep / $store.wizard.totalSteps) * 100) + '%'"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300 ease-out"
                        :style="'width: ' + Math.round(($store.wizard.currentStep / $store.wizard.totalSteps) * 100) + '%'">
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto">
            <!-- Error State -->
            <div x-show="$store.wizard.error" x-transition
                class="mx-6 mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Error</h3>
                        <div class="mt-2 text-sm text-red-700" x-text="$store.wizard.error"></div>
                    </div>
                </div>
            </div>

            <!-- Step Container -->
            <div class="bg-white shadow-lg rounded-lg mx-6 my-6">
                <!-- Step 1: Book Concept -->
                <div x-show="$store.wizard.currentStep === 1" x-data="step1Concept" x-init="init()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tell us about your book idea</h2>
                        <p class="text-gray-600 mb-6">Describe your book concept in 2-3 sentences. This will help us
                            guide you through the creation process.</p>

                        <!-- Debug info for step 1 -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
                            <div>Step 1 Debug: concept=<span x-text="concept?.substring(0, 30) + '...'"></span></div>
                            <div>isValid=<span x-text="isValid"></span>, isSubmitting=<span
                                    x-text="isSubmitting"></span></div>
                        </div>

                        <form @submit.prevent="submitConcept()">
                            <div class="mb-6">
                                <label for="concept" class="block text-sm font-medium text-gray-700 mb-2">
                                    Your Book Concept *
                                </label>
                                <textarea id="concept" x-model="concept"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                    rows="4"
                                    placeholder="Example: A young detective discovers that every crime in her city is connected to an ancient magical artifact that's been influencing people's decisions for centuries."
                                    :disabled="isSubmitting"></textarea>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm"
                                        :class="concept.length < 10 ? 'text-red-500' : concept.length > 1000 ? 'text-red-500' : 'text-gray-500'"
                                        x-text="concept.length + ' characters'"></span>
                                    <span class="text-sm text-gray-500">10-1000 characters</span>
                                </div>
                            </div>

                            <div class="mb-6">
                                <label for="additionalNotes" class="block text-sm font-medium text-gray-700 mb-2">
                                    Additional Notes (Optional)
                                </label>
                                <textarea id="additionalNotes" x-model="additionalNotes"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                    rows="2" placeholder="Any specific themes, tone, or elements you want to include..."
                                    :disabled="isSubmitting"></textarea>
                            </div>

                            <div class="flex justify-end">
                                <button type="submit" :disabled="!isValid || isSubmitting"
                                    class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                    <span x-show="!isSubmitting">Start Creating My Book</span>
                                    <span x-show="isSubmitting">Analyzing Concept...</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Step 2: Genre Selection -->
                <div x-show="$store.wizard.currentStep === 2" x-data="step2Genre()" x-init="init()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Choose Your Genre</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Genre Options -->
                        <div class="space-y-4">
                            <template x-for="option in enhancedOptions" :key="option.id">
                                <div @click="selectGenre(option.id)" :class="getOptionClasses(option.id)"
                                    class="cursor-pointer transition-all duration-200">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>
                                            <div class="flex items-center mt-2 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.commercial_appeal" class="text-sm text-blue-600"
                                                    x-text="'Commercial: ' + option.commercial_appeal"></span>
                                            </div>
                                        </div>
                                        <div x-show="selectedGenre === option.id" class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Subgenre Options (if applicable) -->
                        <div x-show="showSubgenres" x-transition class="mt-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose a Subgenre</h3>
                            <div class="space-y-3">
                                <template x-for="subgenre in subgenreOptions" :key="subgenre.id">
                                    <div @click="selectSubgenre(subgenre.id)" :class="getOptionClasses(subgenre.id)"
                                        class="cursor-pointer transition-all duration-200">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h4 class="font-medium text-gray-800" x-text="subgenre.name"></h4>
                                                <p class="text-gray-600 text-sm mt-1" x-text="subgenre.description"></p>
                                            </div>
                                            <div x-show="selectedSubgenre === subgenre.id" class="ml-4 text-blue-500 flex-shrink-0">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd"
                                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                        clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processGenreSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Audience</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Audience Selection -->
                <div x-show="$store.wizard.currentStep === 3" x-data="step3Audience" x-init="init()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Target Audience</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Audience Options -->
                        <div class="space-y-4">
                            <template x-for="option in options" :key="option.id">
                                <div @click="selectAudience(option.id)" :class="getOptionClasses(option.id)"
                                    class="cursor-pointer transition-all duration-200">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>
                                            <div class="flex items-center mt-2 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.market_size" class="text-sm text-blue-600"
                                                    x-text="'Market: ' + option.market_size"></span>
                                            </div>
                                        </div>
                                        <div x-show="selectedAudience === option.id"
                                            class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processAudienceSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Writing Style</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Writing Style -->
                <div x-show="$store.wizard.currentStep === 4" x-data="step4Style" x-init="init()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Choose Your Writing Style</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Style Options -->
                        <div class="space-y-4">
                            <template x-for="option in options" :key="option.id">
                                <div @click="selectStyle(option.id)" :class="getOptionClasses(option.id)"
                                    class="cursor-pointer transition-all duration-200">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>
                                            <div class="flex items-center mt-2 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.genre_compatibility" class="text-sm text-blue-600"
                                                    x-text="'Compatibility: ' + option.genre_compatibility"></span>
                                            </div>
                                        </div>
                                        <div x-show="selectedStyle === option.id"
                                            class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processStyleSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Book Length</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Book Length -->
                <div x-show="$store.wizard.currentStep === 5" x-data="step5Length"
                    x-init="init(); $watch('$store.wizard.currentStep', (newStep) => { if(newStep === 5) onStepVisible(); })">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Choose Your Book Length</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Debug info for step 5 -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
                            <div>Step 5 Debug: options=<span x-text="options.length"></span>, sessionId=<span
                                    x-text="$store.wizard.sessionId ? 'exists' : 'none'"></span></div>
                            <div>selectedLength=<span x-text="selectedLength"></span>, canProceed=<span
                                    x-text="canProceed"></span></div>
                        </div>

                        <!-- Length Options -->
                        <div class="space-y-4">
                            <template x-for="option in options" :key="option.id">
                                <div @click="selectLength(option.id)" :class="getOptionClasses(option.id)"
                                    class="cursor-pointer transition-all duration-200">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>

                                            <!-- Length Details -->
                                            <div class="mt-3 space-y-2">
                                                <div class="flex items-center space-x-4 text-sm">
                                                    <span class="font-medium text-gray-700">Word Count:</span>
                                                    <span class="text-gray-600" x-text="option.word_count"></span>
                                                </div>
                                                <div class="flex items-center space-x-4 text-sm">
                                                    <span class="font-medium text-gray-700">Time to Write:</span>
                                                    <span x-text="option.time_to_write"
                                                        :class="getTimeBadgeClasses(option.time_to_write)"></span>
                                                </div>
                                                <div class="flex items-center space-x-4 text-sm">
                                                    <span class="font-medium text-gray-700">Publishing Viability:</span>
                                                    <span x-text="option.publishing_viability"
                                                        :class="getViabilityBadgeClasses(option.publishing_viability)"></span>
                                                </div>
                                            </div>

                                            <div class="flex items-center mt-2 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.market_appeal" class="text-sm text-blue-600"
                                                    x-text="'Market: ' + option.market_appeal"></span>
                                            </div>
                                        </div>
                                        <div x-show="selectedLength === option.id"
                                            class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processLengthSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Story Structure</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Story Structure -->
                <div x-show="$store.wizard.currentStep === 6" x-data="step6Structure"
                    x-init="init(); $watch('$store.wizard.currentStep', (newStep) => { if(newStep === 6) onStepVisible(); })">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Choose Your Story Structure</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Debug info for step 6 -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
                            <div>Step 6 Debug: options=<span x-text="options.length"></span>, sessionId=<span
                                    x-text="$store.wizard.sessionId ? 'exists' : 'none'"></span></div>
                            <div>selectedStructure=<span x-text="selectedStructure"></span>, canProceed=<span
                                    x-text="canProceed"></span></div>
                        </div>

                        <!-- Structure Options -->
                        <div class="space-y-4">
                            <template x-for="option in options" :key="option.id">
                                <div @click="selectStructure(option.id)" :class="getStructureCardClass(option)"
                                    @mouseenter="hoveredOption = option.id" @mouseleave="hoveredOption = null">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>

                                            <!-- Structure Details -->
                                            <div class="flex items-center mt-3 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                    :class="getRecommendationBadgeClass(option.recommendation_score)"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.difficulty"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                    :class="getDifficultyBadgeClass(option.difficulty)"
                                                    x-text="formatDifficulty(option.difficulty)"></span>
                                                <span x-show="option.commercial_appeal" class="text-sm text-blue-600"
                                                    x-text="'Appeal: ' + option.commercial_appeal"></span>
                                            </div>

                                            <div x-show="option.why_recommended" class="mt-2">
                                                <p class="text-sm text-gray-500" x-text="option.why_recommended"></p>
                                            </div>
                                        </div>
                                        <div x-show="selectedStructure === option.id"
                                            class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processStructureSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to World Building</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 7: World Building -->
                <div x-show="$store.wizard.currentStep === 7" x-data="step7World"
                    x-init="init(); $watch('$store.wizard.currentStep', (newStep) => { if(newStep === 7) onStepVisible(); })">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">World Building</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Debug info for step 7 -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
                            <div>Step 7 Debug: options=<span x-text="options.length"></span>, sessionId=<span
                                    x-text="$store.wizard.sessionId ? 'exists' : 'none'"></span></div>
                            <div>selectedWorld=<span x-text="selectedWorld"></span>, canProceed=<span
                                    x-text="canProceed"></span></div>
                        </div>

                        <!-- World Options -->
                        <div class="space-y-4">
                            <template x-for="option in options" :key="option.id">
                                <div @click="selectWorld(option.id)" :class="getWorldCardClass(option)"
                                    @mouseenter="hoveredOption = option.id" @mouseleave="hoveredOption = null">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-lg font-semibold text-gray-800" x-text="option.name"></h3>
                                            <p class="text-gray-600 mt-1" x-text="option.description"></p>

                                            <!-- World Details -->
                                            <div class="flex items-center mt-3 space-x-4">
                                                <span x-show="option.recommendation_score"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                    :class="getRecommendationBadgeClass(option.recommendation_score)"
                                                    x-text="formatRecommendationScore(option.recommendation_score)"></span>
                                                <span x-show="option.research_complexity"
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                    :class="getComplexityBadgeClass(option.research_complexity)"
                                                    x-text="formatResearchComplexity(option.research_complexity)"></span>
                                                <span x-show="option.commercial_appeal" class="text-sm text-blue-600"
                                                    x-text="'Appeal: ' + option.commercial_appeal"></span>
                                            </div>

                                            <div x-show="option.why_recommended" class="mt-2">
                                                <p class="text-sm text-gray-500" x-text="option.why_recommended"></p>
                                            </div>
                                        </div>
                                        <div x-show="selectedWorld === option.id"
                                            class="ml-4 text-blue-500 flex-shrink-0">
                                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd"
                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                    clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Continue Button -->
                        <div x-show="canProceed" x-transition class="mt-8 flex justify-end">
                            <button @click="processWorldSelection()" :disabled="isSubmitting"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Content Preferences</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 8: Content Preferences -->
                <div x-show="$store.wizard.currentStep === 8" x-data="step8Content()">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Content Preferences</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Debug info for step 8 (hidden by default) -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs" x-show="false">
                            <div>Step 8 Debug: Using step8Content() function</div>
                            <div>sessionId=<span x-text="$store.wizard.sessionId ? 'exists' : 'none'"></span></div>
                            <div>currentStep=<span x-text="$store.wizard.currentStep"></span></div>
                            <div>contentPreferences length=<span x-text="contentPreferences.length"></span></div>
                            <button @click="logDebugInfo()" class="bg-blue-500 text-white px-2 py-1 rounded text-xs mt-1">
                                Log Debug Info
                            </button>
                        </div>

                        <!-- Content Preferences Input -->
                        <div class="mb-6">
                            <label for="contentPreferences" class="block text-sm font-medium text-gray-700 mb-2">
                                Content Preferences (Optional)
                            </label>
                            <textarea id="contentPreferences" x-model="contentPreferences" @input="updateContentPreferences()"
                                placeholder="Enter any specific themes, content guidelines, or restrictions you'd like for your book..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 resize-vertical"
                                rows="6" maxlength="1000"></textarea>

                            <!-- Character count -->
                            <div class="mt-2 flex justify-between text-sm">
                                <span class="text-gray-500">Optional - helps tailor content to your preferences</span>
                                <span :class="characterCountClass" x-text="`${characterCount}/1000 characters`"></span>
                            </div>
                        </div>

                        <!-- Suggestions (if available) -->
                        <div x-show="suggestions.length > 0" class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-medium text-gray-700">Suggested Content Guidelines</h3>
                                <button @click="showSuggestions = !showSuggestions"
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    <span x-show="!showSuggestions">Show Suggestions</span>
                                    <span x-show="showSuggestions">Hide Suggestions</span>
                                </button>
                            </div>

                            <div x-show="showSuggestions" x-transition class="space-y-2">
                                <template x-for="suggestion in suggestions" :key="suggestion">
                                    <div
                                        class="flex items-start space-x-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <button @click="applySuggestion(suggestion)"
                                            class="flex-shrink-0 text-blue-600 hover:text-blue-800 text-xs font-medium mt-0.5">
                                            Add
                                        </button>
                                        <span class="text-sm text-gray-700" x-text="suggestion"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Validation Error -->
                        <div x-show="!isValid" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                            <p class="text-red-700 text-sm">Content preferences must be 1000 characters or less.</p>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between">
                            <!-- Back Button -->
                            <button @click="goBack()"
                                class="px-4 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
                                â† Back to World Building
                            </button>

                            <!-- Continue Button -->
                            <button @click="proceedToSummary()" :disabled="isSubmitting || !isValid"
                                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
                                <span x-show="!isSubmitting">Continue to Summary</span>
                                <span x-show="isSubmitting">Processing...</span>
                            </button>
                        </div>
                    </div>
                </div>



                <!-- Step 9: Final Summary -->
                <div x-show="$store.wizard.currentStep === 9" x-data="{ 
                    llmMessage: 'Review your book blueprint and finalize your creation.',
                    init() {
                        console.log('Step 9 placeholder init - no API calls');
                    }
                }">
                    <div class="p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Final Summary</h2>
                        <p class="text-gray-600 mb-6" x-text="llmMessage"></p>

                        <!-- Debug info for step 9 -->
                        <div class="mb-4 p-2 bg-gray-100 rounded text-xs">
                            <div>Step 9 Debug: Placeholder implementation</div>
                            <div>sessionId=<span x-text="$store.wizard.sessionId ? 'exists' : 'none'"></span></div>
                        </div>

                        <!-- Show collected data -->
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-semibold text-blue-800 mb-2">ðŸ“‹ Your Book Blueprint</h3>
                            <div class="text-sm text-blue-700 space-y-1">
                                <div><strong>Concept:</strong> <span
                                        x-text="$store.wizard.formData.concept?.substring(0, 100) + '...'"></span></div>
                                <div><strong>Genre:</strong> <span x-text="$store.wizard.formData.genre"></span></div>
                                <div><strong>Audience:</strong> <span x-text="$store.wizard.formData.audience"></span>
                                </div>
                                <div><strong>Style:</strong> <span x-text="$store.wizard.formData.style"></span></div>
                                <div><strong>Length:</strong> <span x-text="$store.wizard.formData.length"></span></div>
                                <div><strong>Structure:</strong> <span x-text="$store.wizard.formData.structure"></span>
                                </div>
                                <div><strong>World:</strong> <span x-text="$store.wizard.formData.world"></span></div>
                            </div>
                        </div>

                        <!-- Placeholder content -->
                        <div class="text-center py-8">
                            <div class="animate-pulse">
                                <p class="text-gray-500">Step 9 (Final Summary) - Under Construction</p>
                                <p class="text-sm text-gray-400 mt-2">This step will be implemented soon.</p>
                            </div>
                        </div>

                        <!-- Completion button -->
                        <div class="mt-8 flex justify-end">
                            <button
                                @click="alert('Book creation completed! Summary: ' + JSON.stringify($store.wizard.formData, null, 2))"
                                class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                                Complete Book Creation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navigation -->
        <div x-data="navigation" class="bg-gray-50 px-8 py-4 border-t">
            <div class="flex justify-between items-center max-w-4xl mx-auto">
                <button
                    @click="$store.wizard.currentStep > 1 ? $store.wizard.setCurrentStep($store.wizard.currentStep - 1) : null"
                    :disabled="$store.wizard.currentStep <= 1"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:text-gray-400 disabled:cursor-not-allowed">
                    â† Back
                </button>

                <div class="text-sm text-gray-500">
                    <span x-text="$store.wizard.currentStep"></span> of <span x-text="$store.wizard.totalSteps"></span>
                </div>

                <!-- Empty div for layout balance -->
                <div></div>
            </div>
        </div>
    </div>
</body>

</html>